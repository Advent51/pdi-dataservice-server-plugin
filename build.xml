<project name="PUR Repository Plugin" basedir="." default="default" xmlns:ivy="antlib:org.apache.ivy.ant">

  <property name="approot.stage.lib.dir" value="lib" />
  <property name="assemble.copy-libs.excludes" value="kettle-*.jar, metro-*.jar, pentaho-xul-*.jar, log4j-*.jar, jface*.jar, groovy*.jar"/>
  <property name="assemble.copy-libs.excludes.obf" value="kettle-*.jar, metro-*.jar, pentaho-xul-*.jar, log4j-*.jar, pentaho-ee-dsc-core-*.jar, pentaho-bi-platform-ee-*.jar, jface*.jar, groovy*.jar"/>
	
  <property name="subfloor-ee.parent.file" value="subfloor-pkg.xml" />
  
  <import file="build-res/subfloor-ee.xml" />
  <!-- Import the subfloor-pkg.xml file which contains all the default tasks -->
  <import file="build-res/subfloor-pkg.xml" />
  <property name="bi-platform-ee-assembly.dir" value="../bi-platform-ee-assembly"/>
  <property name="bi-platform-ee.obflib.dir" value="${bi-platform-ee-assembly.dir}/bin/stage/biserver-ee/tomcat/webapps/pentaho/WEB-INF/lib"/>
  <target name="install">
    <unzip src="${dist.dir}/${package.basename}.zip" dest="${kettle.plugin.dir}" overwrite="true">
    </unzip>
  </target>
  <property name="compilelib.dir"
            value="${basedir}/compile-lib"
            description="Directory for developer to place development Jar files (not affected by clean targets)" />
	
  <!-- Setup the compile classpath -->
  <path id="classpath">
    <fileset dir="${devlib.dir}">
      <include name="**/*.jar" />
    </fileset>
  	<fileset dir="${compilelib.dir}">
      <include name="**/*.jar" />
    </fileset>
    <fileset dir="${lib.dir}">
      <include name="**/*.jar" />
    </fileset>
  </path>
	
  <path id="test.classpath">
    <pathelement path="${testclasses.dir}" />
    <fileset dir="${testlib.dir}">
      <include name="**/*.jar" />
    </fileset>
	<fileset dir="${devlib.dir}">
      <include name="**/*.jar" />
    </fileset>
    <fileset dir="${compilelib.dir}">
      <include name="**/*.jar" />
    </fileset>
    <fileset dir="${lib.dir}">
      <include name="**/*.jar" />
    </fileset>
    <pathelement path="${classes.dir}" />
  </path>

  <target name="clean-jars" depends="subfloor.clean-jars">
  	<delete dir="${compilelib.dir}" />
  </target>
	
  <target name="create-dot-classpath" depends="install-pentaho-ant-tasks,init">
    <dot-classpath>
      <!-- Include all lib dirs -->
    	<classpath>
          <fileset dir="${lib.dir}">
            <include name="*.jar" />
          </fileset>
          <fileset dir="${devlib.dir}">
            <include name="*.jar" />
          </fileset>
  		  <fileset dir="${compilelib.dir}">
  		    <include name="**/*.jar" />
  		  </fileset>
          <fileset dir="${testlib.dir}">
            <include name="*.jar" />
          </fileset>
        </classpath>
    </dot-classpath>
  </target>
	
  <target name="resolve" depends="subfloor.resolve, resolve-compiletime" />
	
  <target name="resolve-compiletime" depends="resolve-init">
    <ivy:resolve file="${ivyfile}" conf="compile" />
    <ivy:retrieve conf="compile" pattern="${compilelib.dir}/[module]-[revision](-[classifier]).[ext]" symlink="${ivy.use.symlinks.internal}" />
  </target>

  <!-- Override assemble to build plugin.xml afterwards -->
  <target name="assemble" depends="subfloor-pkg.assemble, update-plugin-xml" />

  <target name="update-plugin-xml">
    <replace file="${approot.stage.dir}/plugin.xml">
      <replacefilter token="@project.revision@" value="${project.revision}" />
      <replacefilter token="@dependency.bi-platform.revision@" value="${dependency.bi-platform.revision}" />
      <!-- begin remove for the customer src dist -->
      <replacefilter token="@dependency.pentaho-ee-dsc.revision@" value="${dependency.pentaho-ee-dsc.revision}" />
      <!-- end remove for the customer src dist -->
    </replace>
  </target>

  <!-- 
  The following overrides are in place to suppress IVY dependency management.  If you
  want to turn IVY off, you can uncomment these overrides. 
  -->

  <!-- Set default target to skip the ivy "resolve" step -->
  <!--target name="default" depends="clean-all,dist,package" /-->

  <!-- Set the clean-all target to skip the "clean-jars" step.  We do not want our build
  process to delete the "lib" dir -->
  <!--target name="clean-all" depends="clean"/-->

  <!-- begin remove for the customer src dist -->
  <target name="customer-src-codechanges.post">
    <delete>
      <fileset dir="${customer.stage.dir}">
        <include name="**/PluginLicenseVerifier.java" />
      </fileset>
    </delete>
    <copy todir="${customer.stage.dir}/libswt" flatten="false" overwrite="true">
      <fileset dir="libswt"/>
    </copy>
    <copy todir="${customer.stage.dir}/testfiles" flatten="false" overwrite="true">
      <fileset dir="testfiles"/>
    </copy>

  </target>
  <!-- end remove for the customer src dist -->
</project>
