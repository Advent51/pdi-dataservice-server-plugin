<project name="PUR Repository Plugin" basedir="." default="default" xmlns:ivy="antlib:org.apache.ivy.ant">

  <!-- Import the subfloor-pkg.xml file which contains all the default tasks -->
  <import file="build-res/subfloor-pkg.xml" />
  <!-- Defining the folder names for pur and abs plugin -->
  <property name="pur.stage.dir" value="${stage.dir}/${ivy.artifact.id}"/>
  <property name="abs.stage.dir" value="${stage.dir}/${abs.artifact.id}"/>
  <property name="bi-platform-ee-assembly.dir" value="../bi-platform-ee-assembly"/>
  <property name="bi-platform-ee.obflib.dir" value="${bi-platform-ee-assembly.dir}/bin/stage/biserver-ee/tomcat/webapps/pentaho/WEB-INF/lib"/>
  <target name="install">
    <unzip src="${dist.dir}/${package.basename}.zip" dest="${kettle.plugin.dir}" overwrite="true">
    </unzip>
  </target>

  <!-- 
  subfloor overrides 
  -->
  <path id="classpath">
    <fileset dir="${devlib.dir}">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${lib.dir}">
      <include name="*.jar" />
    </fileset>
    <!--
    <fileset dir="../Kettle/lib">
      <include name="*.jar" />
    </fileset>
    -->
  </path>

  <!-- Override to put mock license JAR first -->
  <path id="test.classpath">
    <fileset dir="${devlib.dir}">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${testlib.dir}">
      <include name="*.jar" />
    </fileset>
    <fileset dir="${lib.dir}">
      <include name="*.jar" />
    </fileset>
    <dirset dir="${classes.dir}" />
    <dirset dir="${testclasses.dir}" />
  </path>

  <!-- Override assemble to build plugin.xml afterwards -->
  <target name="assemble" depends="assemble.init,assemble.copy-libs">
    <copy todir="${pur.stage.dir}">
      <fileset file="${package.resdir}/${ivy.artifact.id}/plugin.xml" />
    </copy>
    <chmod perm="a+x" dir="${stage.dir}" includes="**/*.sh" />
    <replace file="${approot.stage.dir}/plugin.xml">
      <replacefilter token="@project.revision@" value="${project.revision}" />
      <replacefilter token="@dependency.bi-platform.revision@" value="${dependency.bi-platform.revision}" />
      <replacefilter token="@dependency.pentaho-ee-dsc.revision@" value="${dependency.pentaho-ee-dsc.revision}" />
    </replace>
  </target>

  <target name="package-zip">
  	<!-- Defining the jar names for pur and abs plugin -->
  	<property name="pur.package.name" value="${ivy.artifact.id}-${project.revision}" />
  	<property name="abs.package.name" value="${abs.artifact.id}-${project.revision}" />
	  <zip destfile="${dist.dir}/${pur.package.name}.zip">
	    <zipfileset dir="${stage.dir}" includes="${ivy.artifact.id}/**"/>
    	
	  </zip>
	  <zip destfile="${dist.dir}/${abs.package.name}.zip">
	    <zipfileset dir="${stage.dir}"  includes="${abs.artifact.id}/**"/>
	  </zip>  	
  </target>
	
  <!-- Copy all jars over to the plugin zip, 
  except for kettle, licensing jars -->
  <target name="assemble.init">
  	<!-- Creating stage folders for pur and abs -->
  	<mkdir dir="${pur.stage.dir}" />
  	<mkdir dir="${abs.stage.dir}" />
  </target>
  <target name="assemble.copy-libs" depends="install-antcontrib">
    <copy todir="${pur.stage.dir}">
      <fileset dir="${lib.dir}">
        <exclude name="kettle-*.jar" />
        <exclude name="pentaho-ee-dsc-core-${dependency.pentaho-ee-dsc.revision}.jar" />
      </fileset>
      <fileset file="${dist.dir}/${ivy.artifact.id}-${project.revision}.jar" />
    </copy>

	<copy todir="${abs.stage.dir}">
		<fileset file="${dist.dir}/${ivy.artifact.id}-${project.revision}.jar" />
	</copy>
    <copy todir="${abs.stage.dir}/lib">
      <fileset dir="${lib.dir}">
      	<exclude name="kettle-*.jar" />
      	<exclude name="pentaho-ee-dsc-core-${dependency.pentaho-ee-dsc.revision}.jar" />
      	<exclude name="pentaho-bi-platform-ee-${dependency.bi-platform.revision}.jar" />
      </fileset>
    </copy>
    <if>
      <available file="${bi-platform-ee.obflib.dir}/pentaho-ee-dsc-core-${dependency.pentaho-ee-dsc.revision}-obf.jar" />
      <then>
        <!-- copy the required obfuscated jars to the plugin dist lib folder -->
      	<!-- We don't trust ProGuard to generate the same obfuscated classes for the dsc jar, so we overwrite it here -->
      	<copy file="${bi-platform-ee.obflib.dir}/pentaho-ee-dsc-core-${dependency.pentaho-ee-dsc.revision}-obf.jar"
      	      tofile="${pur.stage.dir}/pentaho-ee-dsc-core-${dependency.pentaho-ee-dsc.revision}.jar" overwrite="true"/>
      	<copy file="${bi-platform-ee.obflib.dir}/pentaho-bi-platform-ee-${dependency.bi-platform.revision}-obf.jar"
      	      tofile="${pur.stage.dir}/pentaho-bi-platform-ee-${dependency.bi-platform.revision}.jar" overwrite="true"/>
      	<copy file="${bi-platform-ee.obflib.dir}/pentaho-ee-dsc-core-${dependency.pentaho-ee-dsc.revision}-obf.jar"
      	      tofile="${abs.stage.dir}/lib/pentaho-ee-dsc-core-${dependency.pentaho-ee-dsc.revision}.jar" overwrite="true"/>
      	<copy file="${bi-platform-ee.obflib.dir}/pentaho-bi-platform-ee-${dependency.bi-platform.revision}-obf.jar"
      	      tofile="${abs.stage.dir}/lib/pentaho-bi-platform-ee-${dependency.bi-platform.revision}.jar" overwrite="true"/>    	
      </then>
      <else>
        <!-- copy the required jars to the plugin dist lib folder -->
      	<!-- if release=true, we've got a problem, we should blow up here -->
        <copy todir="${pur.stage.dir}" overwrite="true">
          <fileset dir="${lib.dir}">
            <include name="pentaho-ee-dsc-core-${dependency.pentaho-ee-dsc.revision}.jar" />
          	<include name="pentaho-bi-platform-ee-${dependency.bi-platform.revision}.jar" />
          </fileset>
        </copy>
        <copy todir="${abs.stage.dir}/lib" overwrite="true">
          <fileset dir="${lib.dir}">
            <include name="pentaho-ee-dsc-core-${dependency.pentaho-ee-dsc.revision}.jar" />
          	<include name="pentaho-bi-platform-ee-${dependency.bi-platform.revision}.jar" />
          </fileset>
        </copy>
      </else>
    </if>
  </target>

 <target name="dist" depends="jar,package"/>
  <!-- Release process calls this target. -->

  <!-- 
	
	-->
  <target name="obfuscate">

    <move todir="${dist.dir}">
      <fileset dir="${dist.dir}">
        <include name="**/*.jar" />
        <exclude name="**/*-orig.jar" />
      </fileset>
      <mapper type="glob" from="*.jar" to="*-orig.jar" />
    </move>

  	<!-- this project requires the platform ee assembly proguard file being present -->
  	<copy todir="${dist.dir}" file="${bi-platform-ee-assembly.dir}/dist/proguard-biserver-ee-${dependency.bi-platform.revision}.map"/>

    <taskdef resource="proguard/ant/task.properties" classpath="obf-lib/proguard-4.3.jar" />
    <proguard>
      <![CDATA[
      -useuniqueclassmembernames
      -dontoptimize
      -dontshrink
      -dontnote
      -printmapping ${dist.dir}/proguard-${ivy.artifact.id}-${project.revision}.map
      -applymapping ${dist.dir}/proguard-biserver-ee-${dependency.bi-platform.revision}.map 
      -renamesourcefileattribute SourceFile
      -keepattributes SourceFile,LineNumberTable
      -printseeds

      -libraryjars ${java.home}/lib/rt.jar
      -libraryjars ${java.home}/lib/jsse.jar
      -libraryjars ${java.home}/lib/jce.jar
      -libraryjars ${lib.dir}
      -libraryjars ${devlib.dir}
      
      -injars      ${dist.dir}/${ivy.artifact.id}-${project.revision}-orig.jar
      -outjars     ${dist.dir}/${ivy.artifact.id}-${project.revision}.jar
 
	  -keepclasseswithmembernames class * implements org.pentaho.di.repository.Repository {
		  public protected *;
	  }
  	  -keepclasseswithmembernames class * implements org.pentaho.di.repository.RepositorySecurityProvider {
  		  public protected *;
  	  }
	  -keepclasseswithmembernames class * implements ObjectRevision {
		  public protected *;
	  }
	  -keepclasseswithmembernames class * implements org.pentaho.di.repository.RepositoryMeta {
		  public protected *;
	  }
	  -keepclasseswithmembernames class * implements org.pentaho.di.repository.RepositorySecurityProvider {
		  public protected *;
	  }
  	  -keepclasseswithmembernames class * implements org.pentaho.di.repository.RepositorySecurityProvider {
  		  public protected *;
  	  }
  	  -keepclasseswithmembernames class * implements  org.pentaho.di.repository.RepositoryVersionRegistry {
  		  public protected *;
  	  }
      -keepclasseswithmembernames class * implements org.pentaho.ui.xul.impl.AbstractXulEventHandler {
      	public protected *;	
      }
  	  -keep class org.pentaho.di.ui.repository.pur.PurRepositoryDialog {
    		  public protected *;
      }

      -keep class org.pentaho.di.ui.repository.repositoryexplorer.abs.AbsSpoonPlugin {}
	  -keep class org.pentaho.di.ui.repository.repositoryexplorer.abs.controller.* {
  		  public protected *;
      }
      -keepnames class org.pentaho.di.repository.pur.PurRepositoryLocation
    	
      -keepattributes Exceptions, InnerClasses, *Annotation*
    
      ]]>
    </proguard>
  	
  

    <delete>
      <fileset dir="${dist.dir}">
        <include name="**/*-orig.jar" />
      </fileset>
    </delete>

  </target>
	
  <!--=======================================================================
      publish-local-nojar (override)
      
      Publishes repo and abs jar and zip packages locally
      ====================================================================-->
  <target name="publish-local-nojar" depends="install-ivy,subfloor.publish-local-nojar">
  	<antcall target="subfloor-pkg.publish-local-nojar"/>
  	<antcall target="publish-abs-local-nojar">
      <param name="ivy.artifact.id" value="abs-plugin" />
	</antcall>
  </target>
	
  <target name="publish-abs-local-nojar">
    <ivy:resolve file="${package.artifact.ivyfile}" />
    <ivy:publish resolver="local" pubrevision="${project.revision}" overwrite="true" forcedeliver="true">
      <artifacts pattern="${dist.dir}/[artifact]-[revision].[ext]" />
    </ivy:publish>
  </target>

  <!--=======================================================================
      publish-nojar (override)
      
      Publishes repo and abs jar and zip packages
      ====================================================================-->
  <target name="publish-nojar" depends="install-ivy,subfloor.publish-nojar">
  	<antcall target="subfloor-pkg.publish-nojar"/>
  	<antcall target="publish-abs-nojar">
      <param name="ivy.artifact.id" value="abs-plugin" />
	</antcall>
  </target>
	
  <target name="publish-abs-nojar">
    <antcall target="maven-publish-artifact">
      <param name="publish.pomFile" value="${package.artifact.pomfile}" />
      <param name="publish.file" value="${dist.dir}/${package.basename}.zip" />
    </antcall>
  </target>

  <!-- 
    these targets are here for common-build backwards compat, 
    they are needed so the release machine is happy.
  -->
  <target name="publish-pentaho" depends="publish"/>
  <target name="publish-pentaho-nojar" depends="publish-nojar"/>
		

  <!-- 
  The following overrides are in place to suppress IVY dependency management.  If you
  want to turn IVY off, you can uncomment these overrides. 
  -->

  <!-- Set default target to skip the ivy "resolve" step -->
  <!--target name="default" depends="clean-all,dist,package" /-->

  <!-- Set the clean-all target to skip the "clean-jars" step.  We do not want our build
  process to delete the "lib" dir -->
  <!--target name="clean-all" depends="clean"/-->

</project>
